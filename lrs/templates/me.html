{% extends "base.html" %}
{% block title %}{{user.username}} Home{% endblock title %}
{% block heading %}{{user.username}} Home{% endblock heading %}
{% block content %}
</br>
    
<ul id="myTab" class="nav nav-tabs">
  <li><a href="#mystatements" data-toggle="tab">Statements</a></li>
  <li><a href="#publicstatements" data-toggle="tab">Public Feed</a></li>
  <li><a href="#groupstatements" data-toggle="tab">Groups</a></li>
</ul>

<div class="tab-content">
    <div id="mystatements" class="tab-pane">
        <form class="form-inline">
            <label class="checkbox">
                <input id="my_verb_filter_checkbox" type="checkbox" onclick="getStmts()">
            </label>
            Show:
            <select id="my_verb_filter" onchange="initVerbFilter()">
                <option value="">All</option>
                <option value="http://verbs/interaction/">Desktop Apps</option>
                <option value="http://verbs/read/">Selected Texts</option> 
                <option value="http://verbs/started/">Quizzes</option>
                <option value="http://verbs/completed/">Quiz Results</option>
                <option value="http://verbs/watched/">Videos</option>
                <option value="http://verbs/experienced/">Webpages</option>
            </select>
        </form>

        <form class="form-inline">
            <label class="checkbox">
                <input id="my_search_checkbox" type="checkbox" onclick="getStmts()">
            </label>
            Search:
            <input id="my_search" type="text">
        </form></br>        
        <span class="small-link"><a id="delstmts" href="#mystatements" class="btn btn-danger">delete all statements</a></span>
        <h2>Statements:</h2>
    </div>

    <div id="publicstatements" class="tab-pane">
        <form class="form-inline">
            <label class="checkbox">
                <input id="public_user_filter_checkbox" type="checkbox" onclick="getPublicStmts()">
            </label>
            User:
            <input id="public_user_filter" type="text">
        </form></br>
        <form class="form-inline">
            <label class="checkbox">
                <input id="public_verb_filter_checkbox" type="checkbox" onclick="getPublicStmts()">
            </label>
            Show:
            <select id="public_verb_filter" onchange="initPublicVerbFilter()">
                <option value="">All</option>
                <option value="http://verbs/interaction/">Desktop Apps</option>
                <option value="http://verbs/read/">Selected Texts</option> 
                <option value="http://verbs/started/">Quizzes</option>
                <option value="http://verbs/completed/">Quiz Results</option>
                <option value="http://verbs/watched/">Videos</option>
                <option value="http://verbs/experienced/">Webpages</option>
            </select>
        </form>
        <form class="form-inline">
            <label class="checkbox">
                <input id="public_search_checkbox" type="checkbox" onclick="getStmts()">
            </label>
            Search:
            <input id="public_search" type="text"></br>
        </form>
    </div>

    <div id="groupstatements" class="tab-pane">
        <form class="form-inline" name="groupForm" action="javascript:create_group()">
                Group Name:
                <input type="text" id="group_text"/>
                <input name="Submit" type="submit" value="Create"/>
        </form>
        <table>
            <tr>
                <td id="group_column">
                    <span class="heading">Groups:</span><span class="small-link"></span>
                </td>

                <td id="statement_column">
                    <span class="heading">Statements:</span><span class="small-link">Organize statements into groups by dragging and dropping</span>
                </td>
            </tr>
        </table>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<script src="{{ STATIC_URL }}scripts/jquery.easytabs.min.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}scripts/jquery.hashchange.min.js" type="text/javascript"></script>
<script type="text/javascript">
var feedTimeout = null;
var initStmtOff = false;

$(document).ready(function() {
    clearFilters();
    //getStmts();
    $('#myTab a:first').tab('show');
    $(".stmt_link").click(stmtClick);
    $('#tab-container').easytabs({
        defaultTab: "li.default"
    });
    if ($('#mystatements').hasClass('active') && ! $('#mystatements ul').length){
        getStmts();
    }
    if ($('#publicstatements').hasClass('active') && ! $('#publicstatements ul').length){
        getPublicStmts();
    }
    if ($('#groupstatements').hasClass('active') && ! $('#groupstatements ul').length){
        getGroups();
        getStmts_Groups(null, $('#statement_column'));
    }
    $('#tab-container').bind('easytabs:after', function(event, $clicked, $targetPanel, settings){
        if ($targetPanel.attr("id") == "mystatements"){
            //clearFilters();
            getStmts();
        }
         if ($targetPanel.attr("id") == "publicstatements"){
            //clearFilters();
            getPublicStmts();
        }
        if ($targetPanel.attr("id") == "groupstatements"){
            //clearFilters();
            getGroups();
            getStmts_Groups(null, $('#statement_column'));
        }       
    });
    $('#mystatements #delstmts').click(function(){ 
        $.ajax({
            url: "{% url lrs.views.my_statements %}",
            type: "DELETE",
            context: $(this),
            success: function (data){
                getStmts();
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
    });
});

function initUserFilter(){
    var check = document.getElementById("public_user_filter_checkbox");
    check.checked = true;
    getPublicStmts();
}

function initVerbFilter(){
    var check = document.getElementById("my_verb_filter_checkbox");
    check.checked = true;
    getStmts();
}

function initPublicVerbFilter(){
    var check = document.getElementById("public_verb_filter_checkbox");
    check.checked = true;
    getPublicStmts();
}

//Function incase filtering is more complicated later. Called whenever tabs switched.
function clearFilters(){
    var e = document.getElementById("my_verb_filter");
    e.selectedIndex = 0;
    e = document.getElementById("public_verb_filter");
    e.selectedIndex = 0;
}

function getGroups(event){
    if(feedTimeout) {
        clearTimeout(feedTimeout);
    }
    var u = "{% url lrs.views.my_groups %}";
    if (event && event.data.the_url){
        u = event.data.the_url;
    }
    // Request for Groups
    $.ajax({
            url: u,
            type: "GET",
            context: $('#group_column'),
            success: function (data){
                if ($(this).children('ul').length){
                    $(this).children('ul').replaceWith(groupUIData(data));
                }
                else {
                    $(this).append(groupUIData(data));
                }
                $(this).children('ul').find('.group-link').click(groupClick);
                $(this).children('ul').find('.delete-group-link').click(deleteGroup);
                $(this).children('ul').find('li.prev-next a.previous').click(
                        {the_url: $(this).children('ul').find('li.prev-next a.previous').attr("data-target")}, getGroups);
                $(this).children('ul').find('li.prev-next a.next').click(
                        {the_url: $(this).children('ul').find('li.prev-next a.next').attr("data-target")}, getGroups);
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
}

function deleteGroup(event){
    var groupid = $(event.target).parents(".group-field").attr('id');
    $.ajax({
        url: "{% url lrs.views.my_groups %}?group_id="+groupid,
        type: "DELETE",
        success: function(){
            //Reload groups
            getGroups();
        },
        error: function(xhr, ajaxOptions, thrownError){
            alert(thrownError);
        }
    });
}

function getGroupStatements(event, groupid, ele){
    var u = "{% url lrs.views.my_groups %}";

    if (event){
        if(event.data.the_url) {
           u = event.data.the_url;
           ele = $(event.target).parents("div.group-field");
           groupid = ele.attr('id');
        }
    }

    $.ajax({
            url: u,
            type: "GET",
            data: { 'group_id': groupid},
            success: function (data){
                if(!$(ele).children('div#stmts').length){
                    $(ele).find('span.group-content').after('<div id="stmts" style="display:none;"></div>');
                }
                ele = $(ele).find('div#stmts');

                if ($(ele).children('ul').length){
                    $(ele).children('ul').replaceWith(groupStmtUIData(data, groupid));
                }
                else {
                    $(ele).append(groupStmtUIData(data, groupid));
                }

                $(ele).children('ul').find('a.remove-link').click(removeStatement);
                $(ele).children('ul').find('.stmt_link').click(stmtClick);
                $(ele).children('ul').find('li.prev-next a.previous').click(
                        {
                            the_url: $(ele).children('ul').find('li.prev-next a.previous').attr("data-target")
                        }, getGroupStatements);
                $(ele).children('ul').find('li.prev-next a.next').click(
                        {
                            the_url: $(ele).children('ul').find('li.prev-next a.next').attr("data-target")
                        }, getGroupStatements);

                $(ele).slideDown(500);
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
}

function groupClick(event){
    if (event && event.currentTarget){
        ele = event.target;
    }
    findDiv = $(ele).siblings('div#stmts').length;
    if(findDiv===0){
        getGroupStatements(null, $(ele).parent().attr("id"), $(ele).parent());
    }
    else{
        $(ele).siblings('div#stmts').slideToggle();
    }
    return false;
}

function getStmts_Groups(event, element){
    if(feedTimeout) {
        clearTimeout(feedTimeout);
    }
    var u = "{% url lrs.views.my_statements %}";
    var ele = $('#mystatements');

    if (event){
        if(event.data.the_url) {
           u = event.data.the_url;
        }
        if(event.data.context) {
            ele = event.data.context;
        }
    }
    if(element) {
        ele = element;
    }

    var verbFilter;
    var e = document.getElementById("my_verb_filter");

    if(e.selectedIndex == 0){
        verbFilter = null;
    }
    else{
        verbFilter = e.options[e.selectedIndex].value;
    }

    $.ajax({
            url: u,
            type: "GET",
            data: {user_filter:"1", verb_filter:verbFilter},
            context: ele,
            success: function (data){
                if ($(this).children('ul').length){
                    $(this).children('ul').replaceWith(groupStmtUIData(data));
                }
                else {
                    $(this).append(groupStmtUIData(data));
                }
                $(this).children('ul').find('.stmt_link').click(stmtClick);
                $(this).children('ul').find('li.prev-next a.previous').click(
                        {
                            the_url: $(this).children('ul').find('li.prev-next a.previous').attr("data-target"),
                            context: $(this)
                        }, getStmts_Groups);
                $(this).children('ul').find('li.prev-next a.next').click(
                        {
                            the_url: $(this).children('ul').find('li.prev-next a.next').attr("data-target"),
                            context: $(this)
                        }, getStmts_Groups);
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
}

function startDrag(event){
    // Add target to event data
    event.dataTransfer.setData("Text", event.target.id);
}

function dropStmt(event){
    event.preventDefault();
    var ele = event.target;
    if(!$(ele).hasClass('group-field')){
        ele = $(ele).closest("div.group-field");
    }

    // First, retreive dropped item's id and group id
    var stmt_id = event.dataTransfer.getData("Text");
    var group_id = $(ele).attr('id');
    var sendData = { 'stmt_id': stmt_id, 'group_id': group_id };
    

    // Next, send post request to add stmt_id to group_id
    $.ajax({
            url: "{% url lrs.views.my_groups %}",
            type: "POST",
            data: sendData,
            success: function (){
                getGroupStatements(null, group_id, ele);
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
}

function allowDrop(event){
    event.preventDefault();
}

function groupUIData(data){
    if(data['groups'].length == 0) {
        return "<ul><li>no groups</li></ul>";
    }

    var ret = "<ul>";
    for (var i = 0; i < data['groups'].length; i++) {
        var grp = data['groups'][i];
        // Group title
        ret += "<li><div id='" + grp['id'] +"' class='group-field' ondrop='dropStmt(event)' ondragover='allowDrop(event)'>" + grp['name'];
        // Open Group link
        ret += "<a style='float:right; padding-left:1em;' class='group-link' href='#" + grp['id'] + "'>Open</a>";
        // Delete Group link
        ret += "<a style='float:right;' class='delete-group-link' href='#group_column'>Delete</a>";

        ret += "<span class='group-content'></span>";
        ret += "</div></li>";
    }

    var prev = "<span class='previous'>previous</span>";
    if (data['previous']) {
        prev = "<a class='previous' href='#group_column' data-target='" + data['previous'] + "'>previous</a>";
    }
    var next = "<span class='next'>next</span>";
    if (data['next']) {
        next = "<a class='next' href='#group_column' data-target='" + data['next'] + "'>next</a>";
    }
    ret += "<li class='prev-next'>" + prev + next + "</li>";
    ret += "</ul>";

    return ret;
}

function removeStatement(event){

    var stmtid = $(event.target).parents("div.statement").attr('id');
    var groupid = $(event.target).parents("div.group-field").attr('id');

    $.ajax({
        url: "{% url lrs.views.my_groups %}?group_id="+groupid+"&stmt_id="+stmtid,
        type: "DELETE",
        success: function(){
            //Reload group statements
            getGroupStatements(null, groupid, $(event.target).parents("div.group-field"));
        },
        error: function(xhr, ajaxOptions, thrownError){
            alert(thrownError);
        }
    });
}

function groupStmtUIData(data, grpid){
    var ref = 'statement_column';
    if(grpid){
        ref = grpid;
    }

    if (data['stmts'].length == 0){
        return "<ul><li>no statements</li></ul>";
    }

    var ret = "<ul>";

     for (var i = 0; i < data['stmts'].length; i++) {
        var stmt = data['stmts'][i];
        // Statement Container
        ret += "<li><div id='" + stmt['statement_id'] + "' class='statement field' draggable='true' ondragstart='startDrag(event)'>";
        // Statement itself
        ret += "<div class='stmt_link lpad' href='" + stmt['statement_id'] + "'>" + stmt['actor_name'] + " " + stmt['verb'] + " " + stmt['object'];

        // In group, add a remove link
        if(grpid){
            ret += "<a style='float:right;' class='remove-link' href='#"+grpid+"'>Remove</a>";
        }

        ret += "</div></div></li>";
    }

    var prev = "<span class='previous'>previous</span>";
    if (data['previous']) {
        prev = "<a class='previous' href='#" + ref + "' data-target='" + data['previous'] + "'>previous</a>";
    }
    var next = "<span class='next'>next</span>";
    if (data['next']) {
        next = "<a class='next' href='#" + ref + "' data-target='" + data['next'] + "'>next</a>";
    }
    ret += "<li class='prev-next'>" + prev + next + "</li>";

    ret += "</ul>";

    return ret;
}

function verbClick(event){
    if(event && event.currentTarget){
        ele = event.target;
    }
    var stmtid = $(ele).attr("href");

    initStmtOff = true;

    $.ajax({
        url: "{% url lrs.views.my_statements %}?stmt_id="+stmtid,
        type: "GET",
        success: function (data){
            var verb = data['verb'];
            //verbFilter = verb['id'];
            //myFilters['verb'] = verb['id'];

            var e = document.getElementById("my_verb_filter");
            var check = document.getElementById("my_verb_filter_checkbox");
            switch(verb['id'])
            {
                case("http://verbs/completed/"):
                    e.selectedIndex = 4;
                    break;
                case("http://verbs/experienced/"):
                    e.selectedIndex = 6;
                    break;
                case("http://verbs/interaction/"):
                    e.selectedIndex = 1;
                    break;
                case("http://verbs/read/"):
                    e.selectedIndex = 2;
                    break;
                case("http://verbs/started/"):
                    e.selectedIndex = 3;
                    break;
                case("http://verbs/watched/"):
                    e.selectedIndex = 5;
                    break;
            }
            check.checked = true;

            getStmts();
            //getStmts(null, null, verb['id']);
        },
        error: function(xhr, ajaxOptions, thrownError){
            alert(thrownError)
        },
        timeout : 15000
    });    
}

function publicVerbClick(event){
    if(event && event.currentTarget){
        ele = event.target;
    }
    var stmtid = $(ele).attr("href");

    initStmtOff = true;

    $.ajax({
        url: "{% url lrs.views.my_statements %}?stmt_id="+stmtid,
        type: "GET",
        success: function (data){
            var verb = data['verb'];
            //verbFilter = verb['id'];
            //publicFilters['verb'] = verb['id'];

            var e = document.getElementById("public_verb_filter");
            switch(verb['id'])
            {
                case("http://verbs/completed/"):
                    e.selectedIndex = 4;
                    break;
                case("http://verbs/experienced/"):
                    e.selectedIndex = 6;
                    break;
                case("http://verbs/interaction/"):
                    e.selectedIndex = 1;
                    break;
                case("http://verbs/read/"):
                    e.selectedIndex = 2;
                    break;
                case("http://verbs/started/"):
                    e.selectedIndex = 3;
                    break;
                case("http://verbs/watched/"):
                    e.selectedIndex = 5;
                    break;
            }

            getPublicStmts();
        },
        error: function(xhr, ajaxOptions, thrownError){
            alert(thrownError)
        },
        timeout : 15000
    });
}

function stmtClick(event){

    if(initStmtOff){
        initStmtOff = false;
        return false;
    }
    clearTimeout(feedTimeout);
    if (event && event.currentTarget){
        ele = event.target;
    }
    element = $(ele).parents('.statement').find('div#stmts');
    if(!$(element).length){
        getStmtContent($(ele).parent().attr("href"), this);
    }
    else{
        $(element).collapse('toggle');
    }
    return false;
}

function delStmtClick(event){
    if (event && event.currentTarget){
        ele = event.target;
    }
    var id = $(ele).parents('.statement').attr("href");
    console.log("deleting: " + id);
    $.ajax({
        url: "{% url lrs.views.my_statements %}?stmt_id="+id,
        type: "DELETE",
        context: $(this),
        success: function (data){
            getStmts();
        },
        error: function(xhr, ajaxOptions, thrownError){
            alert(thrownError);
        },
        timeout : 15000
    });

    return false;
}

function getPublicStmts(event){
    var u = "{% url lrs.views.my_statements %}";
    var inPage = false;
    if (event && event.data.the_url){
        inPage = true;
        clearTimeout(feedTimeout);
        u = event.data.the_url;
    }

    var userFilter;
    var verbFilter;

    var e = document.getElementById("public_verb_filter");
    var check = document.getElementById("public_verb_filter_checkbox");

    if(e.selectedIndex == 0 || !check.checked){
        verbFilter = null;
    }
    else{
        verbFilter = e.options[e.selectedIndex].value;//myFilters['verb'];
    }

    e = document.getElementById("public_user_filter");
    check = document.getElementById("public_user_filter_checkbox");

    if(!e.value || !check.checked){
        userFilter = "0";
    }
    else{
        userFilter = e.value;
    }

    e = document.getElementById("public_search");
    check = document.getElementById("public_search_checkbox");

    if(!check.checked || e.value == "") {
        objectFilter = null;
    }
    else {
        objectFilter = e.value;
    }

    $.ajax({
            url: u,
            type: "GET",
            data: {user_filter:userFilter, verb_filter:verbFilter, object_filter:objectFilter},
            context: $('#publicstatements'),
            success: function (data){
                if ($(this).children('ul').length){
                    $(this).children('ul').replaceWith(uiData(data,$("#publicstatements"),false));
                }
                else {
                    $(this).append(uiData(data,"publicstatements",false));
                }
                $(this).children('ul').find('.stmt_link').click(stmtClick);
                $(this).children('ul').find('.verb_link').click(publicVerbClick);
                $(this).children('ul').find('li.prev-next a.previous').click(
                        {the_url: $(this).children('ul').find('li.prev-next a.previous').attr("data-target")}, getPublicStmts);
                $(this).children('ul').find('li.prev-next a.next').click(
                        {the_url: $(this).children('ul').find('li.prev-next a.next').attr("data-target")}, getPublicStmts);
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
    if(!inPage)
        feedTimeout = setTimeout(getPublicStmts, 10000);
}

function getStmts(event, element){
    if(feedTimeout) {
        clearTimeout(feedTimeout);
    }
    var u = "{% url lrs.views.my_statements %}";
    var ele = $('#mystatements');

    if (event){
        if(event.data.the_url) {
           u = event.data.the_url;
        }
        if(event.data.context) {
            ele = event.data.context;
        }
    }
    if(element) {
        ele = element;
    }

    var verbFilter;
    var objectFilter;
    var e = document.getElementById("my_verb_filter");
    var check = document.getElementById("my_verb_filter_checkbox");

    if(e.selectedIndex == 0 || !check.checked){
        verbFilter = null;
    }
    else{
        verbFilter = e.options[e.selectedIndex].value;//myFilters['verb'];
    }

    e = document.getElementById("my_search");
    check = document.getElementById("my_search_checkbox");

    if(!check.checked || e.value == "") {
        objectFilter = null;
    }
    else {
        objectFilter = e.value;
    }

    $.ajax({
            url: u,
            type: "GET",
            data: {user_filter:"1", verb_filter:verbFilter, object_filter:objectFilter},
            context: ele,
            success: function (data){
                if ($(this).children('ul').length){
                    $(this).children('ul').replaceWith(uiData(data, this, true));
                }
                else {
                    $(this).append(uiData(data, this, true));
                }
                $(this).children('ul').find('.stmt_link').click(stmtClick);
                $(this).children('ul').find('.delstmt_link').click(delStmtClick);
                $(this).children('ul').find('.verb_link').click(verbClick);
                $(this).children('ul').find('li.prev-next a.previous').click(
                        {
                            the_url: $(this).children('ul').find('li.prev-next a.previous').attr("data-target"),
                            context: $(this)
                        }, getStmts);
                $(this).children('ul').find('li.prev-next a.next').click(
                        {
                            the_url: $(this).children('ul').find('li.prev-next a.next').attr("data-target"),
                            context: $(this)
                        }, getStmts);
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
}

function uiData(data, context, deletable){
    if (data['stmts'].length == 0){
        return "<ul><li>no statements</li></ul>";
    }
    var ret = "<ul class='unstyled pull-left'>";
    for (var i = 0; i < data['stmts'].length; i++) {
        var stmt = data['stmts'][i];
        ret += "<li><div class='statement span5 offset1' href='" + stmt['statement_id'] + "'>";
        ret += stmt['actor_name'] + " ";
        ret += "<a class='verb_link' href='" + stmt['statement_id'] + "'>" + stmt['verb'] + "</a>" + " ";
        ret += stmt['object'];

        ret += "<a class='stmt_link btn btn-primary pull-right' href='#'>Open</a>";
        
        if(deletable){
            ret += "<a class='delstmt_link btn btn-danger pull-right' href='#'>Delete</a>";
        }
        ret += "<span class='stmt-field'></span>"
        ret += "</div></li>";
    }

    var prev = "<li class='disabled'><a href='#'>&laquo;</a></li>";
    if (data['previous']) {
        prev = "<li><a href='#" + $(context).attr('id') + "' data-target='" + data['previous'] + "'>&laquo;</a></li>";
    }
    var next = "<li class='disabled'>&raquo;</li>";
    if (data['next']) {
        next = "<li><a href='#" + $(context).attr('id') + "' data-target='" + data['next'] + "'>&raquo;</a></li>";
    }
    ret += "<li class='pagination offset1'><ul>" + prev + next + "</ul></li>";
    ret += "</ul>";
    return ret;
}

function getStmtContent(stmtid, ele){
    ele = $(ele).siblings(".stmt-field");
    $.ajax({
        url: "{% url lrs.views.my_statements %}?stmt_id="+stmtid,
        type: "GET",
        success: function (data){
            $(ele).after('<div id="stmts" style="display:none;"></div>');
            $(ele).siblings('div#stmts').append(buildContent(data));
            $(ele).siblings('div#stmts').collapse('show');
        },
        error: function(xhr, ajaxOptions, thrownError){
            alert(thrownError)
        },
        timeout : 15000
    });
}

function buildContent(data) {
    var ret = "";
    console.log("buildContent: " + JSON.stringify(data, null, 4));

    var prefix = "http://verbs/";
    if (data.verb.id.search(prefix) != -1) {
        var type = data.verb.id.substring(prefix.length, data.verb.id.length - 1);
        console.log(type);
        switch (type) {
            case "viewed":  // Image,
                var objectLink = data.object.id.substring(0, data.object.id.lastIndexOf('/') + 1);
                ret += "<img src='" + data.object.definition.description['en-US'] + "' alt='' width='375'>";
            break;

            case "watched": // Youtube video
                var videoId = data.object.definition.description['en-US'];
                ret += "<iframe width='420' height='315' src='//www.youtube.com/embed/" + videoId + "?rel=0' frameborder='0' allowfullscreen></iframe>";
            break;

            case "completed": // Quiz
                ret += "Score: " + data.result.score.scaled * 100 + "%<br>";

                var tmpString = "";
                tmpString = data.object.id;
                tmpString = tmpString.slice(tmpString.indexOf("|")+1);

                while(tmpString.length > 0)
                {
                    ret += "<br>&nbsp&nbsp&nbsp&nbsp" + tmpString.substr(0,tmpString.indexOf(":")) + " Score : " + 
                            parseInt(tmpString.substr(tmpString.indexOf(":")+1,tmpString.indexOf("/"))) * 100 + "%";
                    tmpString = tmpString.slice(tmpString.indexOf("/")+1);
                }
            break;

            case "read":    // Text
                 var objectLink = data.object.id.substring(0, data.object.id.lastIndexOf('/') + 1);
                ret += "Link: <a href='" + objectLink + "'>" + objectLink + "</a><br>";
                ret += "<br>Text: <br>" + data.object.definition.description['en-US'].replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + "<br>";
            break;
            case "interaction":    //Desktop App
            break;
            case "started":
            break;
            default:        // Undefined
                ret += "Link: <a href='" + data.object.id + "'>" + data.object.id + "</a><br>";
            break;
        }
    } else {
        // Invalid type
        ret += "Invalid type. Please use http://verbs/..."
    }

    return ret;
}

function syntaxHighlight(json) {
    if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, 4);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    json = json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
    json = json.replace(/(\{|\[)/g, function(match){return '<span class="expandable"><a href="#">' + match +'</a><span class="obj">';});
    return json.replace(/(\}|\])/g, function(match){return '</span>' + match + '</span>'});
}

function create_group (){
    var groupname = $("#group_text").val();
    $.ajax({
            url: "{% url lrs.views.my_groups %}",
            type: "POST",
            data: { name : groupname },
            success: function(){
                $("#group_text").val("");
                getGroups();
            },
            error: function(xhr, ajaxOptions, thrownError){
                alert(thrownError);
            },
            timeout : 15000
        });
}
</script>
{% endblock extra_js %}
